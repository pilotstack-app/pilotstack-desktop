name: Release

# =============================================================================
# SECURITY NOTICE FOR PUBLIC REPOSITORY
# =============================================================================
# This workflow handles sensitive S3 uploads. Security measures implemented:
# 1. Secrets are NEVER logged or exposed in release notes
# 2. S3 bucket names and paths are completely hidden from outputs
# 3. AWS credentials use short-lived sessions via configure-aws-credentials
# 4. All uploads use server-side encryption (AES256)
# 5. Checksums are generated for integrity verification
# 6. Artifact retention is minimized
# 7. ACTOR VALIDATION: Only authorized maintainers can trigger releases
# 8. ENVIRONMENT PROTECTION: S3 upload requires "production" environment approval
# =============================================================================

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      promote_latest:
        description: "Promote existing tag to latest (no build)"
        required: false
        default: false
        type: boolean
      tag_to_promote:
        description: "Tag to promote (e.g., v1.0.0) - only used with promote_latest"
        required: false
        type: string

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  CSC_IDENTITY_AUTO_DISCOVERY: false
  SKIP_NOTARIZATION: true
  # ==========================================================================
  # SECURITY: Authorized release actors (GitHub usernames)
  # Only these users can trigger releases that upload to S3
  # Add your trusted maintainers here
  # ==========================================================================
  AUTHORIZED_ACTORS: "Hamza-Rivon"

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

# SECURITY: Minimal permissions by default
permissions:
  contents: read

jobs:
  # ===========================================================================
  # SECURITY GATE: Validate actor and tag format BEFORE any builds
  # This job MUST pass before any other job runs
  # ===========================================================================
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      authorized: ${{ steps.auth.outputs.authorized }}
    
    steps:
      # SECURITY: Verify the actor is authorized to create releases
      - name: Verify authorized actor
        id: auth
        run: |
          ACTOR="${{ github.actor }}"
          AUTHORIZED="${{ env.AUTHORIZED_ACTORS }}"
          
          echo "ðŸ” Checking authorization for: $ACTOR"
          
          # Check if actor is in the authorized list
          if [[ ",$AUTHORIZED," == *",$ACTOR,"* ]]; then
            echo "âœ… Actor '$ACTOR' is authorized"
            echo "authorized=true" >> "$GITHUB_OUTPUT"
          else
            echo "::error::âŒ UNAUTHORIZED: Actor '$ACTOR' is not authorized to create releases"
            echo "::error::Authorized actors: $AUTHORIZED"
            echo "authorized=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
      
      # SECURITY: Verify this is not from a fork (fork PRs can't access secrets anyway, but be explicit)
      - name: Verify not from fork
        run: |
          if [[ "${{ github.event.repository.fork }}" == "true" ]]; then
            echo "::error::âŒ Releases cannot be triggered from forks"
            exit 1
          fi
          
          # For pull_request events, check head repo
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
              echo "::error::âŒ Releases cannot be triggered from fork PRs"
              exit 1
            fi
          fi
          
          echo "âœ… Running on main repository"
      
      - name: Validate tag format
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.promote_latest }}" == "true" ]]; then
            VERSION="${{ inputs.tag_to_promote }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          # Validate version format (vX.Y.Z or vX.Y.Z-beta.N etc)
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            echo "::error::Expected format: vX.Y.Z or vX.Y.Z-suffix (e.g., v1.0.0, v1.0.0-beta.1)"
            exit 1
          fi
          
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          
          # Check if prerelease
          if [[ "$VERSION" =~ (alpha|beta|rc|dev) ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi
          
          echo "âœ… Version validated: $VERSION"
      
      - name: Security gate summary
        run: |
          {
            echo "## ðŸ” Security Gate Passed"
            echo ""
            echo "| Check | Status |"
            echo "|-------|--------|"
            echo "| Actor Authorization | âœ… ${{ github.actor }} |"
            echo "| Fork Check | âœ… Main repository |"
            echo "| Version Format | âœ… ${{ steps.version.outputs.version }} |"
          } >> "$GITHUB_STEP_SUMMARY"

  # ===========================================================================
  # macOS Build & Upload
  # ===========================================================================
  build-macos:
    name: Build macOS
    needs: security-gate
    if: github.event.inputs.promote_latest != 'true'
    runs-on: macos-latest
    # SECURITY: Use environment protection for S3 access
    # Configure this in: Settings > Environments > production
    # Add required reviewers and deployment branch rules
    environment: production
    outputs:
      checksum_arm64_dmg: ${{ steps.checksums.outputs.arm64_dmg }}
      checksum_x64_dmg: ${{ steps.checksums.outputs.x64_dmg }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          
      - name: Setup Python (for node-gyp)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Install Python setuptools
        run: pip install setuptools
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm run build:packages
      
      - name: Build React app
        run: pnpm run build:react
      
      - name: Build Electron TypeScript
        run: pnpm run build:electron:ts
      
      - name: Build macOS (x64 & arm64)
        run: pnpm exec electron-builder --mac --x64 --arm64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate checksums
        id: checksums
        run: |
          cd release
          
          ARM64_DMG=$(ls *-arm64.dmg 2>/dev/null | head -n 1 || true)
          X64_DMG=$(ls *-x64.dmg 2>/dev/null | head -n 1 || true)
          
          if [[ -n "$ARM64_DMG" ]]; then
            HASH=$(shasum -a 256 "$ARM64_DMG" | cut -d' ' -f1)
            echo "arm64_dmg=$HASH" >> "$GITHUB_OUTPUT"
          fi
          
          if [[ -n "$X64_DMG" ]]; then
            HASH=$(shasum -a 256 "$X64_DMG" | cut -d' ' -f1)
            echo "x64_dmg=$HASH" >> "$GITHUB_OUTPUT"
          fi
      
      # SECURITY: Configure AWS with minimal permissions
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.S3_REGION }}
          mask-aws-account-id: true
      
      # SECURITY: Upload without exposing bucket name in logs
      - name: Upload to secure storage
        env:
          VERSION: ${{ needs.security-gate.outputs.version }}
        run: |
          set -euo pipefail
          
          # SECURITY: Mask the bucket name
          echo "::add-mask::${{ secrets.S3_BUCKET_NAME }}"
          
          cd release
          
          ARM64_DMG=$(ls *-arm64.dmg 2>/dev/null | head -n 1 || true)
          X64_DMG=$(ls *-x64.dmg 2>/dev/null | head -n 1 || true)
          ARM64_ZIP=$(ls *-arm64.zip 2>/dev/null | head -n 1 || true)
          X64_ZIP=$(ls *-x64.zip 2>/dev/null | head -n 1 || true)
          
          BUCKET="${{ secrets.S3_BUCKET_NAME }}"
          BASE="releases/${VERSION}/mac"
          
          echo "ðŸ“¦ Uploading macOS artifacts..."
          
          # Upload versioned files with server-side encryption
          [[ -n "$ARM64_DMG" ]] && aws s3 cp "$ARM64_DMG" "s3://${BUCKET}/${BASE}/pilotstack-${VERSION}-mac-arm64.dmg" \
            --sse AES256 --only-show-errors --no-progress
          [[ -n "$X64_DMG" ]] && aws s3 cp "$X64_DMG" "s3://${BUCKET}/${BASE}/pilotstack-${VERSION}-mac-x64.dmg" \
            --sse AES256 --only-show-errors --no-progress
          [[ -n "$ARM64_ZIP" ]] && aws s3 cp "$ARM64_ZIP" "s3://${BUCKET}/${BASE}/pilotstack-${VERSION}-mac-arm64.zip" \
            --sse AES256 --only-show-errors --no-progress
          [[ -n "$X64_ZIP" ]] && aws s3 cp "$X64_ZIP" "s3://${BUCKET}/${BASE}/pilotstack-${VERSION}-mac-x64.zip" \
            --sse AES256 --only-show-errors --no-progress
          
          # Upload as "latest" for download page
          echo "ðŸ“¦ Updating latest..."
          [[ -n "$ARM64_DMG" ]] && aws s3 cp "$ARM64_DMG" "s3://${BUCKET}/releases/mac/pilotstack-latest-mac-arm64.dmg" \
            --sse AES256 --only-show-errors --no-progress
          [[ -n "$X64_DMG" ]] && aws s3 cp "$X64_DMG" "s3://${BUCKET}/releases/mac/pilotstack-latest-mac-x64.dmg" \
            --sse AES256 --only-show-errors --no-progress
          [[ -n "$ARM64_ZIP" ]] && aws s3 cp "$ARM64_ZIP" "s3://${BUCKET}/releases/mac/pilotstack-latest-mac-arm64.zip" \
            --sse AES256 --only-show-errors --no-progress
          [[ -n "$X64_ZIP" ]] && aws s3 cp "$X64_ZIP" "s3://${BUCKET}/releases/mac/pilotstack-latest-mac-x64.zip" \
            --sse AES256 --only-show-errors --no-progress
          
          echo "âœ… macOS upload complete"

  # ===========================================================================
  # Windows Build & Upload
  # ===========================================================================
  build-windows:
    name: Build Windows
    needs: security-gate
    if: github.event.inputs.promote_latest != 'true'
    runs-on: windows-latest
    environment: production
    outputs:
      checksum_exe: ${{ steps.checksums.outputs.exe }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          
      - name: Setup Python (for node-gyp)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Install Python setuptools
        run: pip install setuptools
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm run build:packages
      
      - name: Build React app
        run: pnpm run build:react
      
      - name: Build Electron TypeScript
        run: pnpm run build:electron:ts
      
      - name: Build Windows (x64)
        run: pnpm exec electron-builder --win --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate checksums
        id: checksums
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path "release" -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exe) {
            $hash = (Get-FileHash $exe.FullName -Algorithm SHA256).Hash.ToLower()
            "exe=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.S3_REGION }}
          mask-aws-account-id: true
      
      - name: Upload to secure storage
        shell: pwsh
        env:
          VERSION: ${{ needs.security-gate.outputs.version }}
          BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          # SECURITY: Mask the bucket name
          Write-Host "::add-mask::$env:BUCKET"
          
          $exe = Get-ChildItem -Path "release" -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          $zip = Get-ChildItem -Path "release" -Filter "*-win-x64.zip" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          $base = "releases/$env:VERSION/windows"
          
          Write-Host "ðŸ“¦ Uploading Windows artifacts..."
          
          if ($exe) {
            aws s3 cp $exe.FullName "s3://$env:BUCKET/$base/pilotstack-$env:VERSION-win-x64.exe" --sse AES256 --only-show-errors --no-progress
            aws s3 cp $exe.FullName "s3://$env:BUCKET/releases/windows/pilotstack-latest-win-x64.exe" --sse AES256 --only-show-errors --no-progress
          }
          
          if ($zip) {
            aws s3 cp $zip.FullName "s3://$env:BUCKET/$base/pilotstack-$env:VERSION-win-x64.zip" --sse AES256 --only-show-errors --no-progress
            aws s3 cp $zip.FullName "s3://$env:BUCKET/releases/windows/pilotstack-latest-win-x64.zip" --sse AES256 --only-show-errors --no-progress
          }
          
          Write-Host "âœ… Windows upload complete"

  # ===========================================================================
  # Linux Build & Upload
  # ===========================================================================
  build-linux:
    name: Build Linux
    needs: security-gate
    if: github.event.inputs.promote_latest != 'true'
    runs-on: ubuntu-latest
    environment: production
    outputs:
      checksum_appimage: ${{ steps.checksums.outputs.appimage }}
      checksum_deb: ${{ steps.checksums.outputs.deb }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          
      - name: Setup Python (for node-gyp)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Install Python setuptools
        run: pip install setuptools
      
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm libarchive-tools
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm run build:packages
      
      - name: Build React app
        run: pnpm run build:react
      
      - name: Build Electron TypeScript
        run: pnpm run build:electron:ts
      
      - name: Build Linux (x64)
        run: pnpm exec electron-builder --linux --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate checksums
        id: checksums
        run: |
          cd release
          
          APPIMAGE=$(ls *.AppImage 2>/dev/null | head -n 1 || true)
          DEB=$(ls *.deb 2>/dev/null | head -n 1 || true)
          
          if [[ -n "$APPIMAGE" ]]; then
            HASH=$(sha256sum "$APPIMAGE" | cut -d' ' -f1)
            echo "appimage=$HASH" >> "$GITHUB_OUTPUT"
          fi
          
          if [[ -n "$DEB" ]]; then
            HASH=$(sha256sum "$DEB" | cut -d' ' -f1)
            echo "deb=$HASH" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.S3_REGION }}
          mask-aws-account-id: true
      
      - name: Upload to secure storage
        env:
          VERSION: ${{ needs.security-gate.outputs.version }}
        run: |
          set -euo pipefail
          
          # SECURITY: Mask the bucket name
          echo "::add-mask::${{ secrets.S3_BUCKET_NAME }}"
          
          cd release
          
          APPIMAGE=$(ls *.AppImage 2>/dev/null | head -n 1 || true)
          DEB=$(ls *.deb 2>/dev/null | head -n 1 || true)
          
          BUCKET="${{ secrets.S3_BUCKET_NAME }}"
          BASE="releases/${VERSION}/linux"
          
          echo "ðŸ“¦ Uploading Linux artifacts..."
          
          [[ -n "$APPIMAGE" ]] && aws s3 cp "$APPIMAGE" "s3://${BUCKET}/${BASE}/pilotstack-${VERSION}-linux-x64.AppImage" \
            --sse AES256 --only-show-errors --no-progress
          [[ -n "$DEB" ]] && aws s3 cp "$DEB" "s3://${BUCKET}/${BASE}/pilotstack-${VERSION}-linux-x64.deb" \
            --sse AES256 --only-show-errors --no-progress
          
          # Upload as "latest"
          echo "ðŸ“¦ Updating latest..."
          [[ -n "$APPIMAGE" ]] && aws s3 cp "$APPIMAGE" "s3://${BUCKET}/releases/linux/pilotstack-latest-linux-x64.AppImage" \
            --sse AES256 --only-show-errors --no-progress
          [[ -n "$DEB" ]] && aws s3 cp "$DEB" "s3://${BUCKET}/releases/linux/pilotstack-latest-linux-x64.deb" \
            --sse AES256 --only-show-errors --no-progress
          
          echo "âœ… Linux upload complete"

  # ===========================================================================
  # Generate SBOM for security/compliance
  # ===========================================================================
  generate-sbom:
    name: Generate SBOM
    needs: security-gate
    if: github.event.inputs.promote_latest != 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          artifact-name: sbom.spdx.json
          output-file: sbom.spdx.json
          
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

  # ===========================================================================
  # Create GitHub Release (SECURITY: No S3 URLs exposed)
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    needs: [security-gate, build-macos, build-windows, build-linux, generate-sbom]
    if: github.event.inputs.promote_latest != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom
          path: artifacts/
      
      - name: Create checksums file
        env:
          MAC_ARM64_DMG: ${{ needs.build-macos.outputs.checksum_arm64_dmg }}
          MAC_X64_DMG: ${{ needs.build-macos.outputs.checksum_x64_dmg }}
          WIN_EXE: ${{ needs.build-windows.outputs.checksum_exe }}
          LINUX_APPIMAGE: ${{ needs.build-linux.outputs.checksum_appimage }}
          LINUX_DEB: ${{ needs.build-linux.outputs.checksum_deb }}
          VERSION: ${{ needs.security-gate.outputs.version }}
        run: |
          cat > artifacts/checksums.txt << EOF
          # SHA256 Checksums for pilotstack ${VERSION}
          # Verify your download: sha256sum -c checksums.txt
          
          ## macOS
          ${MAC_ARM64_DMG}  pilotstack-${VERSION}-mac-arm64.dmg
          ${MAC_X64_DMG}  pilotstack-${VERSION}-mac-x64.dmg
          
          ## Windows
          ${WIN_EXE}  pilotstack-${VERSION}-win-x64.exe
          
          ## Linux
          ${LINUX_APPIMAGE}  pilotstack-${VERSION}-linux-x64.AppImage
          ${LINUX_DEB}  pilotstack-${VERSION}-linux-x64.deb
          EOF
      
      # SECURITY: Release notes do NOT contain any S3 URLs or bucket information
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: pilotstack Desktop ${{ needs.security-gate.outputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ needs.security-gate.outputs.is_prerelease == 'true' }}
          files: |
            artifacts/sbom.spdx.json
            artifacts/checksums.txt
          body: |
            ## ðŸ“¥ Download
            
            Download pilotstack Desktop from our official website:
            
            **ðŸ‘‰ [https://pilotstack.app/download](https://pilotstack.app/download)**
            
            | Platform | Architecture |
            |----------|--------------|
            | macOS | Apple Silicon (M1/M2/M3/M4) |
            | macOS | Intel (x64) |
            | Windows | x64 |
            | Linux | x64 (AppImage) |
            
            ## âœ… Verify Your Download
            
            Download `checksums.txt` and verify the integrity of your download:
            
            ```bash
            # macOS/Linux
            sha256sum -c checksums.txt 2>/dev/null | grep OK
            
            # Windows PowerShell
            Get-FileHash <filename> -Algorithm SHA256
            ```
            
            ## ðŸ”’ Security
            
            - **SBOM**: Review `sbom.spdx.json` for the complete list of dependencies
            - **Source**: Built from commit `${{ github.sha }}`
            - **Build Logs**: [View build provenance](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ## ðŸ“‹ What's Changed
            
            See the auto-generated release notes below.

  # ===========================================================================
  # Manual: Promote existing tag to "latest" (no rebuild)
  # ===========================================================================
  promote-to-latest:
    name: Promote Tag to Latest
    needs: security-gate
    if: github.event.inputs.promote_latest == 'true'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.S3_REGION }}
          mask-aws-account-id: true
      
      - name: Promote to latest
        env:
          VERSION: ${{ needs.security-gate.outputs.version }}
        run: |
          set -euo pipefail
          
          # SECURITY: Mask the bucket name
          echo "::add-mask::${{ secrets.S3_BUCKET_NAME }}"
          
          BUCKET="${{ secrets.S3_BUCKET_NAME }}"
          
          echo "ðŸ”„ Promoting ${VERSION} to latest..."
          
          # macOS
          aws s3 cp "s3://${BUCKET}/releases/${VERSION}/mac/pilotstack-${VERSION}-mac-arm64.dmg" \
            "s3://${BUCKET}/releases/mac/pilotstack-latest-mac-arm64.dmg" \
            --sse AES256 --copy-props none --only-show-errors || true
          aws s3 cp "s3://${BUCKET}/releases/${VERSION}/mac/pilotstack-${VERSION}-mac-x64.dmg" \
            "s3://${BUCKET}/releases/mac/pilotstack-latest-mac-x64.dmg" \
            --sse AES256 --copy-props none --only-show-errors || true
          
          # Windows
          aws s3 cp "s3://${BUCKET}/releases/${VERSION}/windows/pilotstack-${VERSION}-win-x64.exe" \
            "s3://${BUCKET}/releases/windows/pilotstack-latest-win-x64.exe" \
            --sse AES256 --copy-props none --only-show-errors || true
          
          # Linux
          aws s3 cp "s3://${BUCKET}/releases/${VERSION}/linux/pilotstack-${VERSION}-linux-x64.AppImage" \
            "s3://${BUCKET}/releases/linux/pilotstack-latest-linux-x64.AppImage" \
            --sse AES256 --copy-props none --only-show-errors || true
          aws s3 cp "s3://${BUCKET}/releases/${VERSION}/linux/pilotstack-${VERSION}-linux-x64.deb" \
            "s3://${BUCKET}/releases/linux/pilotstack-latest-linux-x64.deb" \
            --sse AES256 --copy-props none --only-show-errors || true
          
          echo "âœ… Promotion complete"
      
      - name: Summary
        env:
          VERSION: ${{ needs.security-gate.outputs.version }}
        run: |
          {
            echo "## âœ… Promoted to Latest"
            echo ""
            echo "**Version:** \`${VERSION}\`"
            echo ""
            echo "The latest download links now point to this version."
          } >> "$GITHUB_STEP_SUMMARY"
